---
- name: Create BSF log directory
  file:
    path: "{{ bsf_log_folder }}"
    owner: "{{ username }}"
    group: adm
    mode: 0775
    state: directory
  tags: ['custom','update']

- name: Configure logrotate to handle our custom logs.
  template: src={{ item.src }} dest=/etc/logrotate.d/{{ item.dest }} owner=root group=root mode=0644
  with_items:
    - src: 000-dateext-for-all.j2
      dest: 000-dateext-for-all
    - src: ansible-pull.logrotate.j2
      dest: ansible-pull
    - src: dpkg-list.logrotate.j2
      dest: dpkg-list
    - src: pip-freeze.logrotate.j2
      dest: pip-freeze
    - src: hwd-info.logrotate.j2
      dest: hwd-info
  tags: ['custom','update']

- name: copy hdw info script
  template: src=hdw_info.sh dest=/home/ideascube/hdw_info.sh mode=755
  tags: ['custom','update']

- name: Copy push_log.sh
  template: src=push_log.sh.j2 dest=/etc/NetworkManager/dispatcher.d/push_log mode=755
  tags: ['custom','update']

- name: Remove old way launching logs files script
  file: path=/etc/dhcp/dhclient-exit-hooks.d/push_log state=absent
  tags: ['custom','update']

- name: fix rights on ansible-pull.log
  file: path=/var/log/ansible-pull.log mode=0644 group=adm
  tags: ['custom','update']

- name: copy idcstats script
  copy: src=idcstats.sh dest=/usr/local/bin/idcstats.sh mode=755
  tags: ['custom','update']

- name: Add a cron entry to run the idcstats script
  cron:
    name: "Run idcstats"
    hour: "*/6"
    minute: "5"
    job: "/usr/local/bin/idcstats.sh"
    state: present
  tags: ['custom','update']

- name: copy APT User-Agent configuration
  copy: src=apt-user-agent.conf dest=/etc/apt/apt.conf.d/99useragent mode=755
  tags: ['custom','update']

- name: Ensure Anacron will run on battery
  lineinfile:
    dest: /etc/default/anacron
    regexp: '^ANACRON_RUN_ON_BATTERY_POWER'
    line: 'ANACRON_RUN_ON_BATTERY_POWER=yes'
    state: present
  tags: ['custom','update']

- include: logs_to_hdd.yml
  when: ext_hdd
  tags:
    - custom
