---
- name: Install iptables
  apt: name=iptables state=latest
  tags: 
    - master

- name: Authorize routing
  replace: dest=/etc/sysctl.conf regexp='^#net.ipv4.ip_forward=1$' replace='net.ipv4.ip_forward=1' backup=yes
  tags: 
    - master

- name: Flush any existing IPtables rule.
  command: "{{item}}"
  with_items:
    - /sbin/iptables -P INPUT ACCEPT
    - /sbin/iptables -P FORWARD ACCEPT
    - /sbin/iptables -P OUTPUT ACCEPT
    - /sbin/iptables -F INPUT
    - /sbin/iptables -F FORWARD
    - /sbin/iptables -F OUTPUT
  tags: ['custom', 'update']
  ignore_errors: yes

- name: Save IPtables empty rules to /etc/iptables.rules
  shell: /sbin/iptables-save > /etc/iptables.rules
  tags: ['master', 'custom','update']

- name: Copy iptables restore file
  copy: src=iptables dest=/etc/network/if-up.d/iptables owner=root group=root mode=755
  tags: 
    - master

- name: Reload sysctl conf
  command: sysctl -p
  tags: 
    - master
