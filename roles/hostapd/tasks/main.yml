---
- name: Unblock wlan
  command: rfkill unblock wlan
  when: (ansible_architecture == 'x86_64' or ansible_architecture == 'i386')
  ignore_errors: yes
  tags: 
    - master

- name: Check if hostapd is already installed
  shell: "dpkg -l | grep hostapd"
  ignore_errors: yes
  register: dpkg_hostapd
  tags: 
    - master

- name: Install hostapd
  apt: name=hostapd state=latest
  when: dpkg_hostapd.stdout == ""
  tags: 
    - master

- name: Remove sysVinit startup file
  file: path=/etc/init.d/hostapd state=absent
  tags: ['master', 'update']

- include_vars: group_vars/{{ ansible_architecture }}.yml
  tags: ['master', 'custom']

- name: Copy hostapd.conf file
  template: src=hostapd.conf.j2 dest=/etc/hostapd/hostapd.conf owner=root group=root mode=755
  tags: ['master', 'custom','rename']

- name: Copy startup script
  copy: src=hostapd dest=/etc/systemd/system/hostapd.service owner=root group=root mode=664
  tags: 
    - master

- name: Enable service hostapd
  service: name=hostapd enabled=yes
  tags: 
    - master
    
- name: Start hostapd
  service: name=hostapd state=started
  tags: 
    - custom

- name: Enable 802.11n
  lineinfile: dest=/etc/hostapd/hostapd.conf
              regexp='ieee80211n=1'
              line='ieee80211n=1'
              insertafter='EOF'
  notify: restart hostapd
  tags: ['custom', 'update']

- name: Enable 802.11n
  lineinfile: dest=/etc/hostapd/hostapd.conf
              regexp='wmm_enabled=1'
              line='wmm_enabled=1'
              insertafter='EOF'
  notify: restart hostapd
  tags: ['custom', 'update']
