- name: Clone/update mook api
  become: True
  become_user: ideascube
  git: repo=ssh://git@altssh.bitbucket.org:443/bsfcampus/mook-bsf-api.git 
    dest={{ mook_path }}/{{ mook_name }}/api
    accept_hostkey=yes 
    force=yes
    version=master
    update=yes
    depth=1
  register: back_installation
  tags: ["custom","update"]

- name: Install specific packages
  apt: name={{ item }} state=latest
  with_items:
    - python-pip
    - python-dev
    - python-pkg-resources
    - unzip
    - libffi6
    - libffi-dev
    - uwsgi-plugin-python
  tags:
    - custom

- name: Create a static dir if we are using an external hard drive
  file: path=/media/hdd/{{ mook_name }}/static/tmp state=directory mode=0755 owner={{ username }} group={{ username }}
  when: ext_hdd
  tags:
    - custom
    
- name: Create symlink if we are using an external hard drive
  file: src=/media/hdd/{{ mook_name }}/static dest={{ mook_path }}/{{ mook_name }}/static state=link
  when: ext_hdd
  tags: ["custom","update"]
    
- name: Create static dir
  file: path={{ mook_path }}/{{ mook_name }}/static/tmp state=directory owner={{username}} group={{username}} mode=0775
  when: (ansible_architecture == 'x86_64' or ansible_architecture == 'i386')
  tags:
    - custom
    
- name: Install python requierment
  pip: requirements=requirements.txt 
    chdir={{ mook_path }}/{{ mook_name }}/api 
    virtualenv_command=/usr/bin/virtualenv 
    virtualenv={{ mook_path }}/{{ mook_name }}/api/env
  when: back_installation.changed == True
  tags: ["custom","update"]

- name: Copy settings_local config files
  template: src=settings_local.py.j2 dest={{ mook_path }}/{{ mook_name }}/api/settings_local.py
  tags: ['custom','rename']

- name: Delete zero octet files
  shell: find ./ -empty -type f -delete chdir="{{ mook_path }}/{{ mook_name }}/static/"
  tags: 
    - update
    
- name: add conf for KoomBook
  lineinfile: dest={{ mook_path }}/{{ mook_name }}/api/settings_local.py 
    regexp='' 
    insertafter=EOF 
    line='    CENTRAL_SERVER_KEY = \"{{ ansible_hostname }}\" \n    CENTRAL_SERVER_SECRET = \"{{ ansible_machine_id }}\"' 
    owner={{username}} group={{username}} mode=755
  tags: ['custom','rename']

- name: Setup startup file for uwsgi
  copy: src=settings_central.py dest={{ mook_path }}/{{ mook_name }}/api 
    owner={{username}} group={{username}} mode=755
  notify: restart mook-sync
  tags:
    - custom
    
