---
- name: Check if iSCSI host is accessible
  wait_for: host={{ bsf_iscsi_host }} port=3260 timeout=3
  register: host_accessible
  failed_when: False

- name: iSCSI detected / Trying to mount target
  block:
    - apt: name=open-iscsi update_cache=yes cache_valid_time=3600
    - open_iscsi: portal={{ bsf_iscsi_host }} login=yes discover=yes target='iqn.2018-04.com.synology:bsf-montreuil.Deploy-1'
    - file: path=/mnt/pkg_source state=directory owner={{ ideascube }} mode=0755
    - mount: src=/dev/sdb1 dest=/mnt/pkg fstype=ext4 state=present
    - stat: path=/mnt/pkg_source/{{ generic_project_name }}
      register: stat_result
  when: host_accessible.state is defined and host_accessible.state == "started"

- include: builded_install.yml
  when: host_accessible.state is defined
    and host_accessible.state == "started"
    and stat_result.stat.exists == True
    and stat_result.stat.isdir == True

- include: regular_install.yml
  when: host_accessible.state is not defined
    or stat_result.stat.exists == False
    or stat_result.stat.isdir == False
