---
- include_vars: group_vars/{{ ansible_architecture }}.yml
  tags: ['custom', 'update','package_management']

- name: Update ideascube catalog cache before downloading
  become: yes
  become_user: ideascube
  shell: ideascube catalog cache update
  tags: ['custom', 'update','package_management']

- name: Install, upgrade or remove a package present in device_list.fact
  become: yes
  become_user: ideascube
  shell: "{% if 'present' in item.status %}grep -m 1 -w \"{{ item.name }}\" /var/ideascube/main/catalog/installed.yml || ideascube catalog install {{ item.name }}
    {% elif 'latest' in item.status %}grep -m 1 -w \"{{ item.name }}\" /var/ideascube/main/catalog/installed.yml || ideascube catalog install {{ item.name }} || ideascube catalog update {{ item.name }} && rm -f /var/cache/ideascube/catalog/packages/{{ item.name }}-*
    {% elif 'absent' in item.status %}grep -m 1 -w \"{{ item.name }}\" /var/ideascube/main/catalog/installed.yml && ideascube catalog remove {{ item.name }} ; echo
    {% else %}echo '[+] nothing to do'{% endif %}"
  with_items: '{{ ansible_local.device_list[generic_project_name].package_management | default(omit) }}'
  when: ansible_local.device_list[generic_project_name].package_management is defined
  register: ideascube_catalog_cmd
  tags: ['custom','update','package_management']

- name: Print out what really happened just before
  debug:   msg={{ ideascube_catalog_cmd.stdout }}
  when: ideascube_catalog_cmd.stdout is defined
  tags: ['custom','update','package_management']
